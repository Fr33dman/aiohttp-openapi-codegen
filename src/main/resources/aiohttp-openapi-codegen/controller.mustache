from __future__ import annotations

from typing import Any, Mapping

from aiohttp import web

{{#imports}}{{import}}
{{/imports}}
from ..handlers.base import HandlerResponse, HandlerResult
from ..handlers.{{handlerModule}} import {{handlerClassName}}

routes = web.RouteTableDef()
BASE_PATH = "{{contextPath}}"
HANDLER_ATTRIBUTE = "{{handlerAttributeName}}"
HANDLER_CLASS = {{handlerClassName}}
_handler: {{handlerClassName}} | None = None


def register_routes(app: web.Application, handler: {{handlerClassName}} | None = None) -> None:
    if handler is None:
        raise RuntimeError("Handler '{{handlerAttributeName}}' must be provided.")
    if not isinstance(handler, {{handlerClassName}}):
        raise TypeError("Handler '{{handlerAttributeName}}' must implement {{handlerClassName}}.")
    global _handler
    _handler = handler
    app.add_routes(routes)


def _get_handler() -> {{handlerClassName}}:
    if _handler is None:
        raise RuntimeError("Handler '{{handlerAttributeName}}' is not configured.")
    return _handler


def _identify_response_variant(
    body: Any,
    variants: list[tuple[type, int]],
) -> tuple[type | None, int | None]:
    for cls, status_code in variants:
        if isinstance(body, cls):
            return cls, status_code
    return None, None


def _to_aiohttp_response(
    result: HandlerResult[Any],
    *,
    response_variants: list[tuple[type, int]],
    default_status: int,
    default_response_cls: type | None,
) -> web.StreamResponse:
    body = result
    explicit_status = None
    headers: Mapping[str, str] | None = None
    if isinstance(result, HandlerResponse):
        body = result.body
        explicit_status = result.status
        headers = result.headers
    if body is None:
        return web.Response(status=explicit_status or default_status, headers=headers)
    matched_cls, matched_status = _identify_response_variant(body, response_variants)
    if isinstance(body, dict):
        target_cls = matched_cls or default_response_cls
        if target_cls is not None:
            body = target_cls.from_dict(body)
            if matched_cls is None:
                matched_cls = target_cls
    payload = body.to_dict() if hasattr(body, "to_dict") else body
    final_status = explicit_status or matched_status or default_status
    return web.json_response(payload, status=final_status, headers=headers)


{{#operations}}
{{#operation}}
@routes.route('{{httpMethod}}', BASE_PATH + '{{{path}}}')
async def {{operationId}}(request: web.Request) -> web.StreamResponse:
    """{{summary}}{{^summary}}{{operationId}}{{/summary}}

    {{notes}}
    """
    response_variants = [
{{#vendorExtensions.x-response-variants}}
        ({{responseClass}}, {{statusCode}}),
{{/vendorExtensions.x-response-variants}}
    ]
    {{#pathParams}}
    {{paramName}} = request.match_info.get('{{baseName}}')
    {{#isInteger}}
    if {{paramName}} is not None:
        {{paramName}} = int({{paramName}})
    {{/isInteger}}
    {{#isLong}}
    if {{paramName}} is not None:
        {{paramName}} = int({{paramName}})
    {{/isLong}}
    {{#isFloat}}
    if {{paramName}} is not None:
        {{paramName}} = float({{paramName}})
    {{/isFloat}}
    {{#isDouble}}
    if {{paramName}} is not None:
        {{paramName}} = float({{paramName}})
    {{/isDouble}}
    {{#isBoolean}}
    if {{paramName}} is not None:
        {{paramName}} = {{paramName}}.lower() in ('true', '1')
    {{/isBoolean}}
    {{/pathParams}}
    {{#queryParams}}
    {{paramName}} = request.rel_url.query.get('{{baseName}}')
    {{/queryParams}}
    {{#headerParams}}
    {{paramName}} = request.headers.get('{{baseName}}')
    {{/headerParams}}
    {{#cookieParams}}
    {{paramName}} = request.cookies.get('{{baseName}}')
    {{/cookieParams}}
    {{#bodyParam}}
    raw_{{paramName}} = None
    if request.can_read_body:
        try:
            raw_{{paramName}} = await request.json()
        except ValueError:
            raw_{{paramName}} = await request.text()
    {{paramName}} = None
    if raw_{{paramName}} is not None:
        {{#isModel}}
        {{paramName}} = {{dataType}}.from_dict(raw_{{paramName}})
        {{/isModel}}
        {{^isModel}}
        {{paramName}} = raw_{{paramName}}
        {{/isModel}}
    {{/bodyParam}}
    {{#formParams}}
    {{#-first}}
    form_data = await request.post()
    {{/-first}}
    {{paramName}} = form_data.get('{{baseName}}')
    {{/formParams}}

    handler = _get_handler()
    result: HandlerResult[{{vendorExtensions.x-handler-result-type}}] = await handler.{{operationId}}(
        request=request{{#vendorExtensions.x-handler-parameters}},
        {{paramName}}={{paramName}}{{/vendorExtensions.x-handler-parameters}}
    )
    return _to_aiohttp_response(
        result,
        response_variants=response_variants,
        default_status={{vendorExtensions.x-default-status-code}},
{{#vendorExtensions.x-default-response-class}}
        default_response_cls={{.}},
{{/vendorExtensions.x-default-response-class}}
{{^vendorExtensions.x-default-response-class}}
        default_response_cls=None,
{{/vendorExtensions.x-default-response-class}}
    )


{{/operation}}
{{/operations}}
